{% load static %}<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}PADD{% endblock %}</title>
  <link rel="icon" href="{% static 'logo.svg' %}">
  <link rel="manifest" href="{% static 'manifest.json' %}">
  <meta name="theme-color" content="#f1c86e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="PADD">
  <link rel="apple-touch-icon" href="{% static 'logo.svg' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/easymde@2.18.0/dist/easymde.min.css">
  <link rel="stylesheet" href="{% static 'css/lcars.css' %}">
  <script src="https://unpkg.com/htmx.org@2.0.4"></script>
  <script src="https://unpkg.com/easymde@2.18.0/dist/easymde.min.js"></script>
  {% block extra_head %}{% endblock %}
</head>
<body hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
  <div class="lcars-app">
    <header class="lcars-header">
      <button class="lcars-header-bracket" onclick="var s=document.getElementById('channel-sidebar');if(s)s.classList.toggle('lcars-sidebar-open')" aria-label="Toggle menu">
        <span class="lcars-menu-bars"><span></span><span></span><span></span></span>
      </button>
      <div class="lcars-header-bar">
        <a href="{% url 'index' %}" class="lcars-header-title">
          <img src="{% static 'wordmark.svg' %}"/>
        </a>
        {% if request.session.user_url %}
          <div class="lcars-user-menu">
            <button class="lcars-user-trigger" onclick="this.parentElement.classList.toggle('lcars-user-menu-open')">
              {% if request.session.user_photo %}
                <img src="{{ request.session.user_photo }}" alt="" class="lcars-user-avatar">
              {% else %}
                <svg class="lcars-user-avatar lcars-user-avatar-default" viewBox="0 0 32 32" fill="none">
                  <circle cx="16" cy="12" r="6" fill="currentColor"/>
                  <path d="M4 28c0-6.627 5.373-12 12-12s12 5.373 12 12" fill="currentColor"/>
                </svg>
              {% endif %}
              <span class="lcars-user-name">{{ request.session.user_name|default:request.session.user_url }}</span>
              <svg class="lcars-user-chevron" width="10" height="6" viewBox="0 0 10 6"><path d="M1 1l4 4 4-4" stroke="currentColor" stroke-width="1.5" fill="none"/></svg>
            </button>
            <div class="lcars-user-dropdown">
              {% if is_admin %}<a href="{% url 'admin' %}" class="lcars-user-dropdown-item">Admin</a>{% endif %}
              <a href="{% url 'settings' %}" class="lcars-user-dropdown-item">Settings</a>
              <a href="{% url 'logout' %}" class="lcars-user-dropdown-item">Log Out</a>
            </div>
          </div>
        {% endif %}
      </div>
    </header>
    <div class="lcars-body">
      {% block sidebar %}{% endblock %}
      <main class="lcars-main" id="main-content">
        <div class="lcars-loading htmx-indicator" id="lcars-loading">
          <div class="lcars-scan-line"></div>
        </div>
        <div id="broadcast-container" hx-get="{% url 'broadcast-banner' %}" hx-trigger="every 30s" hx-swap="innerHTML">
          {% include "partials/broadcast_banner.html" %}
        </div>
        {% block content %}{% endblock %}
      </main>
    </div>
    {% if request.session.micropub_endpoint and not hide_fab %}
    <a href="{% url 'new-post' %}" class="lcars-fab" aria-label="New Post">
      <i class="fas fa-plus"></i>
    </a>
    {% endif %}
    <footer class="lcars-footer">
      <div class="lcars-footer-bracket">Personal Aggregation Display Dashboard</div>
      <div class="lcars-footer-bar"></div>
    </footer>
  </div>
<script>
function toggleReplyEditor(btn) {
  var form = btn.closest('.lcars-entry-content').querySelector('.lcars-reply-form');
  form.classList.toggle('lcars-hidden');
  if (!form.classList.contains('lcars-hidden') && !form._easymde) {
    var ta = form.querySelector('textarea[name=content]');
    form._easymde = new EasyMDE({
      element: ta,
      spellChecker: false,
      status: false,
      placeholder: 'Write a reply...',
      autoDownloadFontAwesome: false,
      toolbar: ['bold', 'italic', 'heading', '|', 'quote', 'unordered-list', 'ordered-list', '|', 'link', 'image', '|', 'preview'],
      minHeight: '120px',
      insertTexts: {
        link: ['[', '](url)'],
        image: ['![', '](url)'],
      },
    });
    form._easymde.codemirror.focus();
  } else if (form._easymde && !form.classList.contains('lcars-hidden')) {
    form._easymde.codemirror.refresh();
    form._easymde.codemirror.focus();
  }
}

function initCollapsibles(root) {
  root.querySelectorAll('.lcars-entry-collapsible:not([data-init])').forEach(el => {
    el.dataset.init = '1';
    const inner = el.querySelector('.lcars-entry-collapse-inner');
    const btn = el.querySelector('.lcars-expand-btn');
    if (inner.scrollHeight <= 200) {
      el.classList.add('lcars-expanded');
      btn.style.display = 'none';
    }
  });
}
initCollapsibles(document);
document.body.addEventListener('htmx:afterSwap', e => {
  initCollapsibles(e.target);
  // Close mobile sidebar after channel switch
  const sidebar = document.getElementById('channel-sidebar');
  if (sidebar) sidebar.classList.remove('lcars-sidebar-open');
});

// Close user dropdown on click outside
document.addEventListener('click', e => {
  document.querySelectorAll('.lcars-user-menu-open').forEach(menu => {
    if (!menu.contains(e.target)) menu.classList.remove('lcars-user-menu-open');
  });
});

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js');
}

function initMarkReadBehavior(root) {
  var timeline = root.querySelector ? root.querySelector('#timeline') || document.getElementById('timeline') : document.getElementById('timeline');
  if (!timeline) return;
  var behavior = timeline.dataset.markReadBehavior;

  if (behavior === 'scroll_past') {
    var observer = new IntersectionObserver(function(entries) {
      entries.forEach(function(ioEntry) {
        if (!ioEntry.isIntersecting && ioEntry.boundingClientRect.top < 0) {
          var el = ioEntry.target;
          observer.unobserve(el);
          htmx.ajax('POST', el.dataset.markReadUrl, {
            values: { channel: el.dataset.channel, entry: el.dataset.entry },
            target: el,
            swap: 'innerHTML'
          });
        }
      });
    }, { threshold: 0 });

    timeline.querySelectorAll('.lcars-entry-read-action').forEach(function(el) {
      observer.observe(el);
    });
  }
}

document.addEventListener('htmx:afterRequest', function(evt) {
  var timeline = document.getElementById('timeline');
  if (!timeline || timeline.dataset.markReadBehavior !== 'interaction') return;
  var path = evt.detail.pathInfo.requestPath;
  if (path.match(/\/api\/micropub\/(like|repost|reply)\//)) {
    if (evt.detail.successful) {
      var article = evt.detail.elt.closest('.lcars-entry');
      if (!article) return;
      var readAction = article.querySelector('.lcars-entry-read-action');
      if (readAction) {
        htmx.ajax('POST', readAction.dataset.markReadUrl, {
          values: { channel: readAction.dataset.channel, entry: readAction.dataset.entry },
          target: readAction,
          swap: 'innerHTML'
        });
      }
    }
  }
});

initMarkReadBehavior(document);
document.body.addEventListener('htmx:afterSwap', function(e) {
  initMarkReadBehavior(e.target);
});
</script>
</body>
</html>
