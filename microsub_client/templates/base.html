{% load static %}<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}PADD{% endblock %}</title>
  <link rel="icon" href="{% static 'logo.svg' %}">
  <link rel="manifest" href="{% static 'manifest.json' %}">
  <meta name="theme-color" content="#f1c86e">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="PADD">
  <link rel="apple-touch-icon" href="{% static 'logo.svg' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/easymde@2.18.0/dist/easymde.min.css">
  <link rel="stylesheet" href="{% static 'css/lcars.css' %}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/htmx.org@2.0.4"></script>
  <script src="https://unpkg.com/easymde@2.18.0/dist/easymde.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  {% block extra_head %}{% endblock %}
</head>
<body hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
  <div class="lcars-app">
    <div class="lcars-loading htmx-indicator" id="lcars-loading">
      <div class="lcars-scan-line"></div>
    </div>
    <header class="lcars-header">
      <button class="lcars-header-bracket" onclick="var s=document.getElementById('channel-sidebar');if(s)s.classList.toggle('lcars-sidebar-open')" aria-label="Toggle menu">
        <span class="lcars-menu-bars"><span></span><span></span><span></span></span>
      </button>
      <div class="lcars-header-bar">
        <a href="{% url 'index' %}" class="lcars-header-title">
          <img src="{% static 'wordmark.svg' %}"/>
        </a>
        {% if request.session.user_url %}
          <div class="lcars-user-menu">
            <button class="lcars-user-trigger" onclick="this.parentElement.classList.toggle('lcars-user-menu-open')">
              {% if request.session.user_photo %}
                <img src="{{ request.session.user_photo }}" alt="" class="lcars-user-avatar">
              {% else %}
                <svg class="lcars-user-avatar lcars-user-avatar-default" viewBox="0 0 32 32" fill="none">
                  <circle cx="16" cy="12" r="6" fill="currentColor"/>
                  <path d="M4 28c0-6.627 5.373-12 12-12s12 5.373 12 12" fill="currentColor"/>
                </svg>
              {% endif %}
              <span class="lcars-user-name">{{ request.session.user_name|default:request.session.user_url }}</span>
              <svg class="lcars-user-chevron" width="10" height="6" viewBox="0 0 10 6"><path d="M1 1l4 4 4-4" stroke="currentColor" stroke-width="1.5" fill="none"/></svg>
            </button>
            <div class="lcars-user-dropdown">
              {% if is_admin %}<a href="{% url 'admin' %}" class="lcars-user-dropdown-item">Admin</a>{% endif %}
              <a href="{% url 'settings' %}" class="lcars-user-dropdown-item">Settings</a>
              <a href="{% url 'logout' %}" class="lcars-user-dropdown-item">Log Out</a>
            </div>
          </div>
        {% endif %}
      </div>
    </header>
    <div class="lcars-body">
      {% block sidebar %}{% endblock %}
      <main class="lcars-main" id="main-content">
        <div id="broadcast-container" hx-get="{% url 'broadcast-banner' %}" hx-trigger="every 30s" hx-swap="innerHTML">
          {% include "partials/broadcast_banner.html" %}
        </div>
        {% block content %}{% endblock %}
      </main>
    </div>
    {% if request.session.micropub_endpoint and not hide_fab %}
    <a href="{% url 'new-post' %}" class="lcars-fab" aria-label="New Post">
      <i class="fas fa-plus"></i>
    </a>
    {% endif %}
    <footer class="lcars-footer">
      <div class="lcars-footer-bracket">Personal Aggregation Display Dashboard</div>
      <div class="lcars-footer-bar"></div>
    </footer>
  </div>
  <div class="lcars-confirm-overlay lcars-hidden" id="lcars-confirm-overlay" aria-hidden="true">
    <div class="lcars-confirm-modal" id="lcars-confirm-modal" role="dialog" aria-modal="true" aria-labelledby="lcars-confirm-title" aria-describedby="lcars-confirm-message">
      <div class="lcars-confirm-accent" aria-hidden="true"></div>
      <div class="lcars-confirm-body">
        <h2 class="lcars-confirm-title" id="lcars-confirm-title">Confirm Action</h2>
        <p class="lcars-confirm-message" id="lcars-confirm-message"></p>
        <div class="lcars-confirm-actions">
          <button class="lcars-button lcars-button-blue lcars-confirm-cancel" id="lcars-confirm-cancel" type="button">Cancel</button>
          <button class="lcars-button lcars-button-orange lcars-confirm-accept" id="lcars-confirm-accept" type="button">Proceed</button>
        </div>
      </div>
    </div>
  </div>
<script>
function toggleReplyEditor(btn) {
  var form = btn.closest('.lcars-entry-content').querySelector('.lcars-reply-form');
  form.classList.toggle('lcars-hidden');
  if (!form.classList.contains('lcars-hidden') && !form._easymde) {
    var ta = form.querySelector('textarea[name=content]');
    form._easymde = new EasyMDE({
      element: ta,
      spellChecker: false,
      status: false,
      placeholder: 'Write a reply...',
      autoDownloadFontAwesome: false,
      toolbar: ['bold', 'italic', 'heading', '|', 'quote', 'unordered-list', 'ordered-list', '|', 'link', 'image', '|', 'preview'],
      minHeight: '120px',
      insertTexts: {
        link: ['[', '](url)'],
        image: ['![', '](url)'],
      },
    });
    form._easymde.codemirror.focus();
  } else if (form._easymde && !form.classList.contains('lcars-hidden')) {
    form._easymde.codemirror.refresh();
    form._easymde.codemirror.focus();
  }
}

function initCollapsibles(root) {
  root.querySelectorAll('.lcars-entry-collapsible:not([data-init])').forEach(el => {
    el.dataset.init = '1';
    const inner = el.querySelector('.lcars-entry-collapse-inner');
    const btn = el.querySelector('.lcars-expand-btn');
    if (inner.scrollHeight <= 200) {
      el.classList.add('lcars-expanded');
      btn.style.display = 'none';
    }
  });
}

function initEntryMaps(root) {
  root.querySelectorAll('.lcars-entry-map:not([data-map-init])').forEach(function(el) {
    el.dataset.mapInit = '1';
    var lat = parseFloat(el.dataset.lat);
    var lng = parseFloat(el.dataset.lng);
    if (isNaN(lat) || isNaN(lng)) return;
    var map = L.map(el, {
      zoomControl: false,
      attributionControl: false,
      dragging: false,
      scrollWheelZoom: false,
      doubleClickZoom: false,
      boxZoom: false,
      keyboard: false,
      touchZoom: false,
    }).setView([lat, lng], 15);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      maxZoom: 19,
    }).addTo(map);
    var pinIcon = L.divIcon({
      className: 'lcars-map-pin',
      html: '<div class="lcars-map-pin-dot"></div><div class="lcars-map-pin-ring"></div>',
      iconSize: [24, 24],
      iconAnchor: [12, 12],
    });
    L.marker([lat, lng], { icon: pinIcon }).addTo(map);
  });
}

initCollapsibles(document);
initEntryMaps(document);
document.body.addEventListener('htmx:afterSwap', e => {
  initCollapsibles(e.target);
  initEntryMaps(e.target);
  // Close mobile sidebar after channel switch
  const sidebar = document.getElementById('channel-sidebar');
  if (sidebar) sidebar.classList.remove('lcars-sidebar-open');
});

// Close user dropdown on click outside
document.addEventListener('click', e => {
  document.querySelectorAll('.lcars-user-menu-open').forEach(menu => {
    if (!menu.contains(e.target)) menu.classList.remove('lcars-user-menu-open');
  });
});


if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js');
}

var _markReadQueue = { entries: [], channel: null, url: null, timer: null };

function _flushMarkReadQueue() {
  var q = _markReadQueue;
  if (!q.entries.length || !q.url) return;
  var entries = q.entries.slice();
  var channel = q.channel;
  var url = q.url;
  q.entries = [];
  q.timer = null;

  // Build form data with multiple entry[] values
  var fd = new FormData();
  fd.append('channel', channel);
  entries.forEach(function(eid) { fd.append('entry[]', eid); });

  // Use fetch for the batch request, then OOB-swap the sidebar via htmx settle
  var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
  if (!csrfToken) csrfToken = document.querySelector('body');
  var headers = { 'X-CSRFToken': document.body.getAttribute('hx-headers') ? JSON.parse(document.body.getAttribute('hx-headers'))['X-CSRFToken'] : '' };

  fetch(url, { method: 'POST', body: fd, headers: headers }).then(function(resp) {
    return resp.text();
  }).then(function(html) {
    // Mark each entry as read in the DOM
    entries.forEach(function(eid) {
      var el = document.querySelector('[data-entry-read="' + CSS.escape(eid) + '"]');
      if (el) el.innerHTML = '<span class="lcars-read-status lcars-read">Read</span>';
    });
    // Process OOB swaps (channel nav update) by letting htmx handle it
    var tmp = document.createElement('div');
    tmp.innerHTML = html;
    tmp.querySelectorAll('[hx-swap-oob]').forEach(function(oob) {
      document.body.appendChild(oob);
      htmx.process(oob);
    });
  });
}

function initMarkReadBehavior(root) {
  var timeline = root.querySelector ? root.querySelector('#timeline') || document.getElementById('timeline') : document.getElementById('timeline');
  if (!timeline) return;
  var behavior = timeline.dataset.markReadBehavior;

  if (behavior === 'scroll_past') {
    var observer = new IntersectionObserver(function(entries) {
      entries.forEach(function(ioEntry) {
        if (!ioEntry.isIntersecting && ioEntry.boundingClientRect.top < 0) {
          var el = ioEntry.target;
          observer.unobserve(el);
          _markReadQueue.channel = el.dataset.channel;
          _markReadQueue.url = el.dataset.markReadUrl;
          _markReadQueue.entries.push(el.dataset.entry);
          if (_markReadQueue.timer) clearTimeout(_markReadQueue.timer);
          _markReadQueue.timer = setTimeout(_flushMarkReadQueue, 500);
        }
      });
    }, { threshold: 0 });

    timeline.querySelectorAll('.lcars-entry-read-action').forEach(function(el) {
      observer.observe(el);
    });
  }
}

document.addEventListener('htmx:afterRequest', function(evt) {
  var timeline = document.getElementById('timeline');
  if (!timeline || timeline.dataset.markReadBehavior !== 'interaction') return;
  var path = evt.detail.pathInfo.requestPath;
  if (path.match(/\/api\/micropub\/(like|repost|reply)\//)) {
    if (evt.detail.successful) {
      var article = evt.detail.elt.closest('.lcars-entry');
      if (!article) return;
      var readAction = article.querySelector('.lcars-entry-read-action');
      if (readAction) {
        htmx.ajax('POST', readAction.dataset.markReadUrl, {
          values: { channel: readAction.dataset.channel, entry: readAction.dataset.entry },
          target: readAction,
          swap: 'innerHTML'
        });
      }
    }
  }
});

initMarkReadBehavior(document);
document.body.addEventListener('htmx:afterSwap', function(e) {
  initMarkReadBehavior(e.target);
});

// Close channel action menus on click outside
document.addEventListener('click', function(e) {
  document.querySelectorAll('.lcars-channel-actions.lcars-actions-open').forEach(function(menu) {
    if (!menu.contains(e.target)) menu.classList.remove('lcars-actions-open');
  });
});

// Channel rename inline edit
function startChannelRename(btn, uid, currentName) {
  btn.closest('.lcars-channel-actions').classList.remove('lcars-actions-open');
  var wrapper = btn.closest('.lcars-channel-wrapper');
  var link = wrapper.querySelector('.lcars-channel-item');
  var nameEl = link.querySelector('.lcars-channel-name');
  var oldText = nameEl.textContent;

  var input = document.createElement('input');
  input.type = 'text';
  input.value = currentName;
  input.className = 'lcars-input lcars-channel-rename-input';

  nameEl.textContent = '';
  nameEl.appendChild(input);
  input.focus();
  input.select();

  function submitRename() {
    var newName = input.value.trim();
    if (newName && newName !== currentName) {
      htmx.ajax('POST', '{% url "channel-rename" %}', {
        values: { channel: uid, name: newName },
        target: '#channel-nav',
        swap: 'innerHTML'
      });
    } else {
      nameEl.textContent = oldText;
    }
  }

  input.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') { e.preventDefault(); submitRename(); }
    if (e.key === 'Escape') { nameEl.textContent = oldText; }
  });
  input.addEventListener('blur', submitRename);
}

// Drag-to-reorder channels
(function() {
  var dragSrc = null;

  document.addEventListener('dragstart', function(e) {
    var wrapper = e.target.closest('.lcars-channel-wrapper');
    if (!wrapper) return;
    dragSrc = wrapper;
    wrapper.classList.add('lcars-dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', wrapper.dataset.channelUid);
  });

  document.addEventListener('dragover', function(e) {
    var wrapper = e.target.closest('.lcars-channel-wrapper');
    if (!wrapper || wrapper === dragSrc) return;
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    var rect = wrapper.getBoundingClientRect();
    var midY = rect.top + rect.height / 2;
    if (e.clientY < midY) {
      wrapper.classList.add('lcars-drag-above');
      wrapper.classList.remove('lcars-drag-below');
    } else {
      wrapper.classList.add('lcars-drag-below');
      wrapper.classList.remove('lcars-drag-above');
    }
  });

  document.addEventListener('dragleave', function(e) {
    var wrapper = e.target.closest('.lcars-channel-wrapper');
    if (wrapper) {
      wrapper.classList.remove('lcars-drag-above', 'lcars-drag-below');
    }
  });

  document.addEventListener('drop', function(e) {
    var target = e.target.closest('.lcars-channel-wrapper');
    if (!target || !dragSrc || target === dragSrc) return;
    e.preventDefault();
    var nav = document.getElementById('channel-nav');
    var rect = target.getBoundingClientRect();
    var midY = rect.top + rect.height / 2;
    if (e.clientY < midY) {
      nav.insertBefore(dragSrc, target);
    } else {
      nav.insertBefore(dragSrc, target.nextSibling);
    }
    target.classList.remove('lcars-drag-above', 'lcars-drag-below');
    // Collect new order and POST
    var uids = [];
    nav.querySelectorAll('.lcars-channel-wrapper').forEach(function(w) {
      uids.push(w.dataset.channelUid);
    });
    htmx.ajax('POST', '{% url "channel-order" %}', {
      values: { 'channels[]': uids },
      target: '#channel-nav',
      swap: 'innerHTML'
    });
  });

  document.addEventListener('dragend', function(e) {
    if (dragSrc) dragSrc.classList.remove('lcars-dragging');
    document.querySelectorAll('.lcars-drag-above, .lcars-drag-below').forEach(function(el) {
      el.classList.remove('lcars-drag-above', 'lcars-drag-below');
    });
    dragSrc = null;
  });
})();

// Replace native hx-confirm dialogs with the LCARS modal.
var _lcarsConfirm = {
  activeEvent: null,
  previousFocus: null,
};

function closeLcarsConfirm(confirmed) {
  var overlay = document.getElementById('lcars-confirm-overlay');
  if (!overlay || overlay.classList.contains('lcars-hidden')) return;
  overlay.classList.add('lcars-hidden');
  overlay.setAttribute('aria-hidden', 'true');
  document.body.classList.remove('lcars-modal-open');

  var activeEvent = _lcarsConfirm.activeEvent;
  _lcarsConfirm.activeEvent = null;

  if (_lcarsConfirm.previousFocus && _lcarsConfirm.previousFocus.focus) {
    _lcarsConfirm.previousFocus.focus();
  }
  _lcarsConfirm.previousFocus = null;

  if (confirmed && activeEvent && activeEvent.detail && typeof activeEvent.detail.issueRequest === 'function') {
    activeEvent.detail.issueRequest(true);
  }
}

function openLcarsConfirm(evt) {
  var overlay = document.getElementById('lcars-confirm-overlay');
  var modal = document.getElementById('lcars-confirm-modal');
  var message = document.getElementById('lcars-confirm-message');
  var acceptBtn = document.getElementById('lcars-confirm-accept');
  if (!overlay || !modal || !message || !acceptBtn) return;

  _lcarsConfirm.activeEvent = evt;
  _lcarsConfirm.previousFocus = document.activeElement;

  message.textContent = evt.detail.question || 'Are you sure you want to continue?';
  overlay.classList.remove('lcars-hidden');
  overlay.setAttribute('aria-hidden', 'false');
  document.body.classList.add('lcars-modal-open');
  acceptBtn.focus();
}

document.body.addEventListener('htmx:confirm', function(evt) {
  if (!evt.detail || !evt.detail.question) return;
  evt.preventDefault();
  openLcarsConfirm(evt);
});

document.getElementById('lcars-confirm-cancel').addEventListener('click', function() {
  closeLcarsConfirm(false);
});

document.getElementById('lcars-confirm-accept').addEventListener('click', function() {
  closeLcarsConfirm(true);
});

document.getElementById('lcars-confirm-overlay').addEventListener('click', function(e) {
  if (e.target.id === 'lcars-confirm-overlay') closeLcarsConfirm(false);
});

document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeLcarsConfirm(false);
});

</script>
</body>
</html>
